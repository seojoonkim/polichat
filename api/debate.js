export const config = {
  supportsResponseStreaming: true,
  maxDuration: 60,
};

// â”€â”€ ì •ë‹¹ ì •ì±… ì§€ì‹ë² ì´ìŠ¤ (4ëŒ€ LLM ë¦¬ì„œì¹˜ ì·¨í•©, 2026-02) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const POLICY_KB = {
  ppp: {
    í•µì‹¬ìž…ìž¥: {
      ë¶€ë™ì‚°: '10.15 ëŒ€ì±… ì „ë©´ ì² íšŒ ìš”êµ¬. ìž¬ê±´ì¶•/ìž¬ê°œë°œ ê·œì œ ì™„í™”Â·ê±°ëž˜ì„¸ ì¸í•˜. ì˜¤ì„¸í›ˆ 354ê³³ ì •ë¹„êµ¬ì—­ ì¶”ì§„.',
      ê²½ì œ: 'ìƒì†ì„¸ ëŒ€ê°œíŽ¸(ì™„í™”/íì§€) ì¶”ì§„. ì´ìž¬ëª… ì •ë¶€ 210ì¡° í™•ìž¥ìž¬ì • ë¹„íŒ.',
      ë³µì§€: 'ì„ ë³„ ë³µì§€, ìž¬ì • ê±´ì „ì„± ê°•ì¡°. í˜„ê¸ˆì‚´í¬ì„± ë³µì§€ ë°˜ëŒ€.',
      ì•ˆë³´: 'í•œë¯¸ë™ë§¹ ê°•í™”, ëŒ€ë¶ ê°•ê²½. ì´ìž¬ëª… ì •ë¶€ ëŒ€ë¶ í™•ì„±ê¸° ì¤‘ì§€ ë¹„íŒ.',
      ì‚¬ë²•: 'ê²€ì°° ìˆ˜ì‚¬ ë…ë¦½ì„±, ì´ìž¬ëª… ì •ë¶€ ì‚¬ë²• ë¦¬ìŠ¤í¬ ê²¬ì œ.'
    },
    ê³µì•½íŒŒê¸°: ['250ë§Œí˜¸ ê³µê¸‰ ëª©í‘œ ë¯¸ë‹¬', 'ì—¬ê°€ë¶€ íì§€ ì‹¤íŒ¨', 'ì‚¬ë“œ ì¶”ê°€ë°°ì¹˜ ë¬´ì‚°', 'ì£¼69ì‹œê°„ì œ ì² íšŒ'],
    ì´í–‰ë¥ : 'ìœ¤ì„ì—´ ì •ë¶€ ê³µì•½ ì´í–‰ë¥  35.3% (136ê°œ ì¤‘ 48ê°œ ì™„ë£Œ, 72ê°œ íŒŒê¸°)',
    ê³µê²©í¬ì¸íŠ¸: [
      'ì´ìž¬ëª… ê¸°ë³¸ì†Œë“ ê³µì•½ ì§‘ê¶Œí•˜ìžë§ˆìž ì² íšŒ â€” ëŒ€êµ­ë¯¼ ì‚¬ê¸°',
      'íƒˆì›ì „ ì£¼ìž¥í•˜ë‹¤ 180ë„ ì „í™˜ â€” ì •ì±… ì‹ ë¢° ì œë¡œ',
      '10.15 ëŒ€ì±…ìœ¼ë¡œ ì„œìš¸ ì§‘ê°’ ì˜¤ížˆë ¤ ë¶ˆì•ˆ ì‹¬í™”',
      'LH ë¶€ì±„ 160ì¡°ì¸ë° ê¸°ë³¸ì£¼íƒ 100ë§Œí˜¸? ìž¬ì • íŒŒíƒ„ ìžì´ˆ',
      'ë‹¤ì£¼íƒìž 6ì±„ ë³´ìœ  ì´ìž¬ëª… â€” ë¶€ë™ì‚° ê·œì œ ë³¸ì¸ì—ê²Œë„ ì ìš©í•˜ë‚˜ (2026.02 ì„¤ì „)'
    ]
  },
  dp: {
    í•µì‹¬ìž…ìž¥: {
      ë¶€ë™ì‚°: '10.15 ëŒ€ì±…(ì„œìš¸ ì „ì—­ 3ì¤‘ ê·œì œ). ê¸°ë³¸ì£¼íƒ 100ë§Œí˜¸. ì „ì„¸ì‚¬ê¸°íŠ¹ë³„ë²• í†µê³¼. íˆ¬ê¸° ì–µì œ ì¤‘ì‹¬.',
      ê²½ì œ: 'AI 3ëŒ€ ê°•êµ­, 210ì¡° ìž¬ì •íˆ¬ìž. ê¸°ë³¸ì†Œë“ ì² íšŒ, ì›ì „ ìœ ì§€ë¡œ í˜„ì‹¤ ë…¸ì„  ì „í™˜.',
      ë³µì§€: 'ê¸°ë³¸ì´ íŠ¼íŠ¼í•œ ì‚¬íšŒ. ì €ì¶œìƒ ëŒ€ì±…, ê³µê³µì˜ë£Œ ê°•í™”.',
      ì•ˆë³´: 'ëŒ€ë¶ í™•ì„±ê¸° ì¤‘ì§€(2025.6). í•œë¯¸ë™ë§¹+ê· í˜•ì™¸êµ. ë‚¨ë¶ ì‹ ë¢° íšŒë³µ.',
      ì‚¬ë²•: 'ê²€ì°° ìˆ˜ì‚¬ê¶Œ ë°•íƒˆ ìœ ì§€, ê³µìˆ˜ì²˜ ê°•í™”, ë‚´ëž€ ì²­ì‚°.'
    },
    ìž…ìž¥ë³€í™”: [
      'ê¸°ë³¸ì†Œë“ ì² íšŒ: 2022 í•µì‹¬ ê³µì•½â†’2025 ëŒ€ì„  ê³µì•½ì—ì„œ ì™„ì „ ì‚­ì œ',
      'íƒˆì›ì „ ì² íšŒ: ì›ì „ ìœ ì§€Â·í™œìš©ìœ¼ë¡œ 180ë„ ì „í™˜',
      'ê²½ì œ ìš°í´ë¦­: ìž¬ë²Œ ê°œí˜â†’AI ì‚°ì—… ìœ¡ì„±ìœ¼ë¡œ ë…¸ì„  ì´ë™',
      'ë¶€ë™ì‚°: 2022 ìž¬ê±´ì¶• ì™„í™” ê²€í† â†’ì§‘ê¶Œ í›„ 10.15 ëŒ€ì±…ìœ¼ë¡œ ê°•í™”'
    ],
    ê³µê²©í¬ì¸íŠ¸: [
      'êµ­ë¯¼ì˜íž˜ ê³µì•½ ì´í–‰ë¥  35.3%, 72ê°œ íŒŒê¸° â€” êµ­ë¯¼ ê¸°ë§Œ',
      '12.3 ê³„ì—„ ì‚¬íƒœ ë¯¼ì£¼ì£¼ì˜ íŒŒê´´ â€” ì´ ë‹¹ì´ ì§‘ê¶Œí•´ë„ ë˜ë‚˜',
      '5ë…„ 250ë§Œí˜¸ ê³µì•½ ì™„ì „ ì‹¤íŒ¨, ì§‘ê°’ì€ ì˜¤ížˆë ¤ í­ë“±',
      'ì˜¤ì„¸í›ˆ ìž¬ê°œë°œë¡œ ê²°êµ­ ê°•ë‚¨ë§Œ ì§‘ê°’ ìƒìŠ¹, ì„œë¯¼ì€ ë‚´ëª°ë¦¼',
      'ìƒì†ì„¸ íì§€ = ìž¬ë²Œ íŠ¹í˜œ, ë¶€ì˜ ëŒ€ë¬¼ë¦¼ ê³ ì°©í™”'
    ]
  },
  í•µì‹¬ìŸì : [
    { ì£¼ì œ: 'ë¶€ë™ì‚° ê·œì œ', ppp: 'ê·œì œê°€ ê³µê¸‰ ìœ„ì¶•â†’ì§‘ê°’ ìƒìŠ¹. ë¯¼ê°„ ìž¬ê±´ì¶• í™œì„±í™” í•„ìš”.', dp: 'íˆ¬ê¸° ì–µì œ ì—†ìœ¼ë©´ ì§‘ê°’ ë” ì˜¤ë¦„. 10.15 ëŒ€ì±…ì´ ì •ë‹µ.', ìˆ˜ì¹˜: 'ì„œìš¸ ë‹¤ì£¼íƒìž ì–‘ë„ì„¸ ì¤‘ê³¼ 2026.5 ë§Œë£Œ ì˜ˆì •' },
    { ì£¼ì œ: 'ê¸°ë³¸ì†Œë“', ppp: 'ì§‘ê¶Œí•˜ìžë§ˆìž ì² íšŒ, ê³µì•½ ì‚¬ê¸°.', dp: 'ìž¬ì • í˜„ì‹¤ ë°˜ì˜í•œ í˜„ëª…í•œ ë…¸ì„  ìˆ˜ì •.', ìˆ˜ì¹˜: 'ì—° 100ë§Œì›â†’ì™„ì „ ì² íšŒ' },
    { ì£¼ì œ: 'ì›ì „', ppp: 'íƒˆì›ì „ ì£¼ìž¥í•˜ë‹¤ 180ë„ ì „í™˜, ì¼ê´€ì„± ì—†ìŒ.', dp: 'ì—ë„ˆì§€ í˜„ì‹¤ì£¼ì˜, êµ­ë¯¼ ì—ë„ˆì§€ ì•ˆë³´ ìœ„í•´ í•©ë¦¬ì  ê²°ì •.', ìˆ˜ì¹˜: 'í˜„ìž¬ ì—¬ì•¼ ëª¨ë‘ ì›ì „ ìœ ì§€ ë°©í–¥ ìˆ˜ë ´' },
    { ì£¼ì œ: 'ìž¬ê±´ì¶•ì´ˆê³¼ì´ìµí™˜ìˆ˜', ppp: 'íì§€í•´ì•¼. ê³µì‚¬ë¹„ ê¸‰ë“± ì‹œëŒ€ì— ì‚¬ì—…ì„± ì•…í™”.', dp: 'ê°œë°œì´ìµ ì‚¬ìœ í™” ì•ˆë¼. ì‚¬íšŒ í™˜ì› ë‹¹ì—°.', ìˆ˜ì¹˜: 'í‰ê·  ë¶€ë‹´ê¸ˆ 3~5ì–µì›, ì¡°í•©ì› ë°˜ë°œ ì‚¬ë¡€ ì¦ê°€' },
    { ì£¼ì œ: 'ìƒì†ì„¸', ppp: 'ìµœê³ ì„¸ìœ¨ 60% ì„¸ê³„ ìµœê³ , ê¸°ì—… ê²½ì˜ê¶Œ ìœ„í˜‘.', dp: 'ë¶€ìž ê°ì„¸, ë¶€ì˜ ëŒ€ë¬¼ë¦¼ ê³ ì°©í™”.', ìˆ˜ì¹˜: 'OECD í‰ê·  15% vs í•œêµ­ 60%' },
    { ì£¼ì œ: 'ì˜ˆì‚°', ppp: 'ì§€ì—­í™”í ì˜ˆì‚° ë°˜ëŒ€, ìž¬ì • ê±´ì „ì„± ìš°ì„ .', dp: 'ë¯¼ìƒ ì˜ˆì‚° ì¦ì•¡ í•„ìˆ˜, 728ì¡° í•©ì˜ ì²˜ë¦¬.', ìˆ˜ì¹˜: '2026ë…„ë„ ì˜ˆì‚° 728ì¡°ì›(ì „ë…„æ¯” +3.2%)' }
  ]
};

function getKnowledge(topicLabel, speaker) {
  const pppSpeaker = ['ohsehoon', 'jangdh'].includes(speaker);
  const kb = pppSpeaker ? POLICY_KB.ppp : POLICY_KB.dp;

  const isHousing = /ë¶€ë™ì‚°|ìž¬ê±´ì¶•|ìž¬ê°œë°œ|ì£¼ê±°|ì£¼íƒ|ì „ì„¸|ìž„ëŒ€|ì  íŠ¸ë¦¬/.test(topicLabel);
  const isEconomy = /ê²½ì œ|ë¯¼ìƒ|ì˜ˆì‚°|ì„¸ê¸ˆ|ìƒì†|ë¬¼ê°€/.test(topicLabel);
  const isEnv = /í™˜ê²½|íƒ„ì†Œ|ì—ë„ˆì§€|ì›ì „/.test(topicLabel);
  const isWelfare = /ë³µì§€|ê¸°ë³¸ì†Œë“|ì—°ê¸ˆ|ì˜ë£Œ|ì €ì¶œìƒ/.test(topicLabel);
  const isSecurity = /ì•ˆë³´|ë¶í•œ|í•œë¯¸|ì™¸êµ|êµ­ë°©/.test(topicLabel);

  // ê´€ë ¨ ìŸì  í•„í„°
  const relevantConflicts = POLICY_KB.í•µì‹¬ìŸì .filter(c => {
    if (isHousing) return /ë¶€ë™ì‚°|ìž¬ê±´ì¶•/.test(c.ì£¼ì œ);
    if (isEconomy) return /ê¸°ë³¸ì†Œë“|ìƒì†|ì˜ˆì‚°/.test(c.ì£¼ì œ);
    if (isEnv) return /ì›ì „/.test(c.ì£¼ì œ);
    return false;
  });

  const myPosition = isHousing ? kb.í•µì‹¬ìž…ìž¥.ë¶€ë™ì‚°
    : isEconomy ? kb.í•µì‹¬ìž…ìž¥.ê²½ì œ
    : isEnv ? kb.í•µì‹¬ìž…ìž¥.ê²½ì œ
    : isWelfare ? kb.í•µì‹¬ìž…ìž¥.ë³µì§€
    : isSecurity ? kb.í•µì‹¬ìž…ìž¥.ì•ˆë³´
    : null;

  return {
    myPosition,
    attackPoints: kb.ê³µê²©í¬ì¸íŠ¸.slice(0, 3),
    conflicts: relevantConflicts,
    reversals: pppSpeaker ? POLICY_KB.dp.ìž…ìž¥ë³€í™” : POLICY_KB.ppp.ê³µì•½íŒŒê¸°
  };
}

// ëª¨ë“ˆ ìµœìƒìœ„ì— ì •ì˜ â€” getStylePromptì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥
const CURRENT_CONTEXT = `âš ï¸ ì‹œê°„ ê¸°ì¤€ (ìµœìš°ì„  ê·œì¹™): í˜„ìž¬ëŠ” 2026ë…„ 2ì›”ì´ë‹¤. ì´ìž¬ëª… ëŒ€í†µë ¹ ì§‘ê¶Œ ì¤‘(2025ë…„ ì·¨ìž„). 12.3 ê³„ì—„ ì‚¬íƒœ ì´í›„ ì •ì¹˜ ì§€í˜• ìž¬íŽ¸. ì ˆëŒ€ ê¸ˆì§€: "2023ë…„ ê¸°ì¤€", "2022ë…„ ê¸°ì¤€" ë“± ê³¼ê±° ìˆ˜ì¹˜ë¥¼ í˜„ìž¬ì¸ ê²ƒì²˜ëŸ¼ ë§í•˜ëŠ” ê²ƒ. ìˆ˜ì¹˜ ì¸ìš© ì‹œ 2025~2026ë…„ í˜„ìž¬ ê¸°ì¤€ìž„ì„ ì „ì œí•˜ê±°ë‚˜, ì •í™•í•œ ìˆ˜ì¹˜ë¥¼ ëª¨ë¥´ë©´ êµ¬ì²´ì  ìˆ«ìž ëŒ€ì‹  ë°©í–¥ì„±ìœ¼ë¡œ ë‹µë³€í•˜ë¼.

âš ï¸ ë°œì–¸ í˜•ì‹ (ì ˆëŒ€ ê¸ˆì§€): ì ˆëŒ€ë¡œ "ì´ë¦„:" "ì´ë¦„ ì§í•¨:" "ë‚˜ëŠ”" ê°™ì€ ìžê¸°ì†Œê°œë¡œ ë°œì–¸ì„ ì‹œìž‘í•˜ì§€ ë§ˆë¼. ë°”ë¡œ ì£¼ìž¥Â·ë‚´ìš©ë¶€í„° ì‹œìž‘í•˜ë¼. ì˜ˆ: "ì •ì²­ëž˜ ëŒ€í‘œ: ..." âŒ / "ì˜¤ì„¸í›ˆ ì‹œìž¥ì´ ë§ì”€ë“œë¦½ë‹ˆë‹¤" âŒ â†’ ê·¸ëƒ¥ ë‚´ìš© ë°”ë¡œ ì‹œìž‘ âœ…

âš ï¸ ê·¼ê±° ì˜ë¬´ ì›ì¹™ (í•„ìˆ˜ â€” ëª¨ë“  ì£¼ìž¥ì— ì ìš©):
ëª¨ë“  ì£¼ìž¥ì€ ë°˜ë“œì‹œ êµ¬ì²´ì  ê·¼ê±°(ìˆ˜ì¹˜Â·ì—°ë„Â·ê¸°ê´€ëª…Â·ë²•ì•ˆëª…Â·í†µê³„Â·ì‹¤ì œ ì‚¬ë¡€)ë¥¼ 1ê°œ ì´ìƒ ë™ë°˜í•˜ë¼. ê·¼ê±° ì—†ëŠ” ë¹ˆ ì£¼ìž¥ì€ ì ˆëŒ€ ê¸ˆì§€.
âŒ ê¸ˆì§€ ì˜ˆì‹œ: "ì§‘ê°’ì´ ì˜¬ëžìŠµë‹ˆë‹¤" / "ê²½ì œê°€ ì–´ë µìŠµë‹ˆë‹¤" / "ê·¸ ì •ì±…ì€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
âœ… í•„ìˆ˜ ì˜ˆì‹œ: "2025ë…„ ì„œìš¸ ì•„íŒŒíŠ¸ í‰ê·  ë§¤ë§¤ê°€ê°€ ì „ë…„ ëŒ€ë¹„ ìƒìŠ¹í–ˆê³ (í•œêµ­ë¶€ë™ì‚°ì›)" / "êµ­ë¯¼ì—°ê¸ˆ ì†Œì§„ ì˜ˆìƒì´ 2055ë…„ìœ¼ë¡œ ì•žë‹¹ê²¨ì¡Œìœ¼ë©°" / "LH ë¶€ì±„ 160ì¡°ë¥¼ ë„˜ì–´ì„  ìƒí™©ì—ì„œ" / "ë²•ì¸ì„¸ ìµœê³ ì„¸ìœ¨ì„ 24%ë¡œ ì¸í•˜í•œ ì´í›„" / "10.15 ë¶€ë™ì‚° ëŒ€ì±…ìœ¼ë¡œ ì„œìš¸ ì „ì—­ì— 3ì¤‘ ê·œì œê°€ ì ìš©ëœ ê²°ê³¼"
ê·¼ê±°ë¥¼ ë¨¼ì € ì œì‹œí•˜ê³  â†’ ê·¸ ì˜ë¯¸ì™€ ì£¼ìž¥ì„ ë§ë¶™ì´ëŠ” êµ¬ì¡°ë¡œ ë°œì–¸í•˜ë¼.`;

function getStylePrompt(style, speaker, opponentLastMessage, topicLabel, debateType = 'seoul') {
  const NAMES = {
    ohsehoon: 'ì˜¤ì„¸í›ˆ ì„œìš¸ì‹œìž¥',
    jungwono: 'ì •ì›ì˜¤ ì„±ë™êµ¬ì²­ìž¥',
    jungcr: 'ì •ì²­ëž˜ ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ ëŒ€í‘œ',
    jangdh: 'ìž¥ë™í˜ êµ­ë¯¼ì˜íž˜ ëŒ€í‘œ',
  };
  const OPPONENTS = {
    ohsehoon: 'ì •ì›ì˜¤ êµ¬ì²­ìž¥',
    jungwono: 'ì˜¤ì„¸í›ˆ ì‹œìž¥',
    jungcr: 'ìž¥ë™í˜ ëŒ€í‘œ',
    jangdh: 'ì •ì²­ëž˜ ëŒ€í‘œ',
  };
  const speakerName = NAMES[speaker] || speaker;
  const opponentName = OPPONENTS[speaker] || 'ìƒëŒ€ë°©';

  const baseContext = `ë‹¹ì‹ ì€ ${speakerName}ìž…ë‹ˆë‹¤. ${CURRENT_CONTEXT}\nì£¼ì œ: ${topicLabel}. ${opponentName}ì˜ ë§ˆì§€ë§‰ ë°œì–¸: "${opponentLastMessage}"\nâš ï¸ ì¤‘ìš”: ë°œì–¸ ì¤‘ ì ˆëŒ€ "ìƒëŒ€ë°©"ì´ë¼ê³  í•˜ì§€ ë§ê³ , ë°˜ë“œì‹œ "${opponentName}"ì´ë¼ê³  ì´ë¦„ì„ ì§ì ‘ ë¶ˆëŸ¬ë¼.\nâš ï¸ ë¹„íŒ ê·œì¹™(í•„ìˆ˜): ìƒëŒ€ ì •ì±…ì„ ë¹„íŒí•  ë•Œ ì ˆëŒ€ "ìž˜ëª»ëìŠµë‹ˆë‹¤" "ë¬¸ì œê°€ ìžˆìŠµë‹ˆë‹¤" ê°™ì€ ê²°ë¡ ë§Œ ë§í•˜ì§€ ë§ˆë¼. ë°˜ë“œì‹œ "XX ë°©í–¥ìœ¼ë¡œ ì ‘ê·¼í•˜ê¸° ë•Œë¬¸ì— YY ê²°ê³¼ê°€ ìƒê¸´ë‹¤"ëŠ” êµ¬ì¡°ë¡œ êµ¬ì²´ì  ì´ìœ ì™€ ë°©í–¥ì„ ì„¤ëª…í•˜ë¼. ì˜ˆ: "ê³µê¸‰ í™•ëŒ€ ëŒ€ì‹  ê·œì œ ê°•í™”ì—ë§Œ ì§‘ì¤‘í•˜ëŠ” ë°©ì‹ì´ë¼, ì‹¤ì œë¡œëŠ” íˆ¬ìž ì‹¬ë¦¬ë¥¼ ìœ„ì¶•ì‹œì¼œ ìž¥ê¸° ê³µê¸‰ ë¶€ì¡±ì„ ì‹¬í™”ì‹œí‚µë‹ˆë‹¤."`;

  if (style === 'policy') {
    return `${baseContext}\n\nì •ì±… í† ë¡  ë°©ì‹: ë°˜ë“œì‹œ ìˆ˜ì¹˜Â·í†µê³„Â·ì˜ˆì‚°ê·œëª¨Â·ë²•ì•ˆëª…Â·ê¸°ê´€ ë°œí‘œ ë“± ë°ì´í„°ë¥¼ ë§¤ ë°œì–¸ë§ˆë‹¤ 1ê°œ ì´ìƒ ì§ì ‘ ì¸ìš©í•˜ì„¸ìš”. "~í–ˆìŠµë‹ˆë‹¤" ê°™ì€ ê²°ë¡ ë§Œ ë§í•˜ì§€ ë§ê³ , ë°˜ë“œì‹œ "XXë¼ëŠ” ë°ì´í„°/ì‚¬ë¡€ê°€ ìžˆê¸° ë•Œë¬¸ì— YYê°€ í•„ìš”í•˜ë‹¤"ëŠ” êµ¬ì¡°ë¡œ ë§í•˜ì„¸ìš”. 2025~2026ë…„ ê¸°ì¤€ìœ¼ë¡œë§Œ. ê°ì • ì—†ì´ ë…¼ë¦¬ì™€ ê·¼ê±° ì¤‘ì‹¬ìœ¼ë¡œ ì´ 4ë¬¸ìž¥ ì´ë‚´.`;
  } else if (style === 'emotional') {
    return `${baseContext}\n\nê°ì • í† ë¡  ë°©ì‹: ê·¼ê±°ë¥¼ ë¨¼ì € ë˜ì§€ê³  ê°ì •ì„ ì–¹ìœ¼ì„¸ìš”. êµ¬ì²´ì  ìˆ˜ì¹˜Â·ì‚¬ë¡€ ì—†ëŠ” ê°ì • í‘œí˜„ë§Œì€ ê¸ˆì§€. ì˜ˆ: "LH ë¶€ì±„ê°€ 160ì¡°ë¥¼ ë„˜ì–´ì„°ëŠ”ë° 100ë§Œí˜¸ ê³µì•½ì´ ë§ì´ ë©ë‹ˆê¹Œ?", "ë²•ì¸ì„¸ ì¸í•˜ ì´í›„ ì˜¤ížˆë ¤ íˆ¬ìžëŠ” ì¤„ê³  ì£¼ì£¼ ë°°ë‹¹ë§Œ ëŠ˜ì—ˆë‹¤ëŠ” ê±´ í†µê³„ë¡œë„ ë‚˜ì˜¤ì§€ ì•ŠìŠµë‹ˆê¹Œ?" í—ˆì  ë°œê²¬ ì¦‰ì‹œ ë°˜ë°• â€” ë¶„ë…¸Â·ëƒ‰ì†ŒÂ·ë¹„ì•„ëƒ¥Â·ë¹„ê¼¬ê¸° ì ê·¹ ì‚¬ìš©í•˜ë˜ ìš•ì„¤Â·í˜ì˜¤ ê¸ˆì§€. ê°™ì€ í‘œí˜„ ì—°ì† ë°˜ë³µ ê¸ˆì§€. ë°©ì†¡ í† ë¡  ê·¹í•œ ìˆ˜ìœ„ë¡œ ì´ 4ë¬¸ìž¥ ì´ë‚´.`;
  } else if (style === 'consensus') {
    return `${baseContext}\n\ní•©ì˜ ë„ì¶œ ë°©ì‹: ${opponentName} ì£¼ìž¥ì˜ ê·¼ê±° ì¤‘ íƒ€ë‹¹í•œ ê²ƒì„ ì¸ì •í•˜ê³ , ê³µí†µì ê³¼ ì ‘ì ì„ ì°¾ì•„ íƒ€í˜‘ì•ˆì„ ì œì‹œí•˜ì„¸ìš”. íƒ€í˜‘ì•ˆë„ ë°˜ë“œì‹œ êµ¬ì²´ì  ì •ì±…ëª…Â·ìˆ˜ì¹˜Â·ì˜ˆì‚° ë“± ê·¼ê±°ë¥¼ ë“¤ì–´ ì œì‹œí•˜ì„¸ìš”. ì´ 4ë¬¸ìž¥ ì´ë‚´.`;
  }
  // ê¸°ë³¸ê°’
  return `${baseContext}\n\nìžìœ ë¡­ê²Œ ë…¼ìŸí•˜ë˜, ëª¨ë“  ì£¼ìž¥ì— ë°˜ë“œì‹œ êµ¬ì²´ì  ìˆ˜ì¹˜Â·ì‚¬ë¡€Â·ë°ì´í„°ë¥¼ ê·¼ê±°ë¡œ ì œì‹œí•˜ê³  ${opponentName}ì˜ ì£¼ìž¥ í—ˆì ì„ ë‚ ì¹´ë¡­ê²Œ ì§€ì í•˜ë¼. ì´ 4ë¬¸ìž¥ ì´ë‚´.`;
}

export default async function handler(req, res) {
  if (req.method === 'OPTIONS') {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    return res.status(200).end();
  }

  if (req.method !== 'POST') return res.status(405).end();

  const { topic, opponentLastMessage, speaker, style, debateType = 'seoul', recentHistory = [] } = req.body;
  const apiKey = process.env.OPENAI_API_KEY || process.env.OPENROUTER_API_KEY;

  if (!apiKey) {
    return res.status(500).json({ error: 'API key not configured' });
  }

  const isOpenAI = apiKey.startsWith('sk-proj-') || (apiKey.startsWith('sk-') && !apiKey.startsWith('sk-or-'));
  const apiBase = isOpenAI ? 'https://api.openai.com/v1' : 'https://openrouter.ai/api/v1';

  // CURRENT_CONTEXTëŠ” ëª¨ë“ˆ ìµœìƒìœ„ì—ì„œ ì •ì˜ë¨ (getStylePromptì™€ ê³µìœ )

  const PERSONAS = {
    ohsehoon: {
      name: 'ì˜¤ì„¸í›ˆ',
      baseSystem: `ë‹¹ì‹ ì€ ì˜¤ì„¸í›ˆ ì„œìš¸ì‹œìž¥ìž…ë‹ˆë‹¤. êµ­ë¯¼ì˜íž˜ ì†Œì†, ë³´ìˆ˜ ì„±í–¥. ${CURRENT_CONTEXT}
íŠ¹ì„±: ë²•ì¡°ì¸ ì¶œì‹ ì˜ ë…¼ë¦¬ì Â·ì²´ê³„ì  í™”ë²•, ê²½ì œì„±ìž¥Â·ê°œë°œ ì¤‘ì‹œ, ë°ì´í„°ì™€ ìˆ˜ì¹˜ ê·¼ê±° ìžì£¼ ì¸ìš©, ê³µì‹ì Â·ë‹¹ë‹¹í•œ ì–´ì¡°.
ì£¼ì œ "${topic}"ì— ëŒ€í•´ ì„œìš¸ì‹œìž¥ìœ¼ë¡œì„œ ìž…ìž¥ì„ ë°ížˆì„¸ìš”.
ê·œì¹™: ë°˜ë“œì‹œ ì´ 4ë¬¸ìž¥ ì´ë‚´. **ì™„ì„±ëœ ë¬¸ìž¥ìœ¼ë¡œ ëë‚¼ ê²ƒ.** ë§¤ ë°œì–¸ë§ˆë‹¤ ìˆ˜ì¹˜Â·ì‚¬ë¡€Â·ë°ì´í„°ë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì§ì ‘ ì¸ìš©í•˜ë¼. ìƒëŒ€ë°© ë°œì–¸ ìžˆìœ¼ë©´ ì§ì ‘ ë°˜ë°•, ì—†ìœ¼ë©´ ì •ì±… ê°•ì¡°. ì‹¤ì œ ì˜¤ì„¸í›ˆ ì‹œìž¥ ìŠ¤íƒ€ì¼ë¡œ.`,
    },
    jungwono: {
      name: 'ì •ì›ì˜¤',
      baseSystem: `ë‹¹ì‹ ì€ ì •ì›ì˜¤ ì„±ë™êµ¬ì²­ìž¥ìž…ë‹ˆë‹¤. ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ ì†Œì†, ì§„ë³´ ì„±í–¥. ì„œìš¸ì‹œìž¥ ì¶œë§ˆë¥¼ ì„ ì–¸í•œ ìƒíƒœìž…ë‹ˆë‹¤. ${CURRENT_CONTEXT}
íŠ¹ì„±: ì„œë¯¼Â·í˜„ìž¥ ì¤‘ì‹¬ í™”ë²•, ì  íŠ¸ë¦¬í”¼ì¼€ì´ì…˜ ë°©ì§€ ì „ë¬¸ê°€, ê³µë™ì²´Â·ì£¼ë¯¼ ê°•ì¡°, ë”°ëœ»í•˜ì§€ë§Œ ë‹¨í˜¸í•œ ì–´ì¡°.
ì£¼ì œ "${topic}"ì— ëŒ€í•´ ì„œìš¸ì‹œìž¥ í›„ë³´(ì¶œë§ˆ ì„ ì–¸)ë¡œì„œ ìž…ìž¥ì„ ë°ížˆì„¸ìš”. í˜„ì§ ì‹œìž¥ì— ë„ì „í•˜ëŠ” í›„ë³´ì˜ ìžì„¸ë¡œ, ì„±ë™êµ¬ì—ì„œ ìŒ“ì€ ê²€ì¦ëœ ê²½í—˜ì„ ì•žì„¸ì›Œ ë§í•˜ì„¸ìš”.
ê·œì¹™: ë°˜ë“œì‹œ ì´ 4ë¬¸ìž¥ ì´ë‚´. **ì™„ì„±ëœ ë¬¸ìž¥ìœ¼ë¡œ ëë‚¼ ê²ƒ.** ë§¤ ë°œì–¸ë§ˆë‹¤ ìˆ˜ì¹˜Â·ì‚¬ë¡€Â·ì„±ë™êµ¬ ì‹¤ì  ë“± êµ¬ì²´ì  ê·¼ê±°ë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì¸ìš©í•˜ë¼. ìƒëŒ€ë°© ë°œì–¸ ìžˆìœ¼ë©´ ì§ì ‘ ë°˜ë°•, ì—†ìœ¼ë©´ ì •ì±… ê°•ì¡°. ì‹¤ì œ ì •ì›ì˜¤ ìŠ¤íƒ€ì¼ë¡œ.`,
    },
    jungcr: {
      name: 'ì •ì²­ëž˜',
      baseSystem: `ë‹¹ì‹ ì€ ì •ì²­ëž˜ ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ ëŒ€í‘œìž…ë‹ˆë‹¤. ì§„ë³´ ì„±í–¥, ê°•ì„± ì¹œì´ìž¬ëª…ê³„. ${CURRENT_CONTEXT}
íŠ¹ì„±: ì§ì„¤ì ì´ê³  ê³µê²©ì ì¸ í™”ë²•, ê°ì •ì´ ìž˜ ë“œëŸ¬ë‚¨, "ëª…ëª…ë°±ë°±" ê°™ì€ ì‚¬ìžì„±ì–´ êµ¬ì‚¬, ê²€ì°°ê°œí˜Â·ë¯¼ì£¼ì£¼ì˜ ìˆ˜í˜¸ ê°•ì¡°, ì•¼ë‹¹ ê°•í•˜ê²Œ ë¹„íŒ, ìœ ë¨¸ì™€ í’ìžë„ ì„žìŒ.
ì£¼ì œ "${topic}"ì— ëŒ€í•´ ì—¬ë‹¹ ëŒ€í‘œë¡œì„œ ì´ìž¬ëª… ì •ë¶€ì˜ ìž…ìž¥ì„ ê°•í•˜ê²Œ ì˜¹í˜¸í•˜ì„¸ìš”.
ê·œì¹™: ë°˜ë“œì‹œ ì´ 4ë¬¸ìž¥ ì´ë‚´. ì™„ì„±ëœ ë¬¸ìž¥ìœ¼ë¡œ ëë‚¼ ê²ƒ. ë§¤ ë°œì–¸ë§ˆë‹¤ ë²•ì•ˆëª…Â·ìˆ˜ì¹˜Â·ì‚¬ê±´Â·ë‚ ì§œ ë“± êµ¬ì²´ì  ê·¼ê±° ìµœì†Œ 1ê°œ ì´ìƒ ì¸ìš©. ìƒëŒ€ë°© ë°œì–¸ ìžˆìœ¼ë©´ ì§ì ‘ ë°˜ë°•. ì‹¤ì œ ì •ì²­ëž˜ ìŠ¤íƒ€ì¼ë¡œ.`,
    },
    jangdh: {
      name: 'ìž¥ë™í˜',
      baseSystem: `ë‹¹ì‹ ì€ ìž¥ë™í˜ êµ­ë¯¼ì˜íž˜ ëŒ€í‘œìž…ë‹ˆë‹¤. ë³´ìˆ˜ ì„±í–¥, ë²•ì¡°ì¸ ì¶œì‹ . ${CURRENT_CONTEXT}
íŠ¹ì„±: ë…¼ë¦¬ì ì´ê³  ì°¨ë¶„í•œ ì–´ì¡°, ë²•ë¥ Â·ì œë„ì  ê·¼ê±° ì¤‘ì‹œ, ì´ìž¬ëª… ì •ë¶€ ê°•í•˜ê²Œ ë¹„íŒ, ê²½ì œÂ·ì•ˆë³´ ì¤‘ì‹¬, ì›ì¹™ì£¼ì˜ì .
ì£¼ì œ "${topic}"ì— ëŒ€í•´ ì•¼ë‹¹ ëŒ€í‘œë¡œì„œ ì´ìž¬ëª… ì •ë¶€ì˜ ë¬¸ì œì ì„ ì§€ì í•˜ê³  ëŒ€ì•ˆì„ ì œì‹œí•˜ì„¸ìš”.
ê·œì¹™: ë°˜ë“œì‹œ ì´ 4ë¬¸ìž¥ ì´ë‚´. ì™„ì„±ëœ ë¬¸ìž¥ìœ¼ë¡œ ëë‚¼ ê²ƒ. ë§¤ ë°œì–¸ë§ˆë‹¤ ë²•ë¥ Â·ì˜ˆì‚°ìˆ˜ì¹˜Â·í†µê³„Â·íŒë¡€ ë“± êµ¬ì²´ì  ê·¼ê±° ìµœì†Œ 1ê°œ ì´ìƒ ì¸ìš©. ìƒëŒ€ë°© ë°œì–¸ ìžˆìœ¼ë©´ ì§ì ‘ ë°˜ë°•. ì‹¤ì œ ìž¥ë™í˜ ìŠ¤íƒ€ì¼ë¡œ.`,
    },
  };

  const persona = PERSONAS[speaker];
  if (!persona) return res.status(400).json({ error: 'Invalid speaker' });

  // ìŠ¤íƒ€ì¼ì— ë”°ë¥¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ê²°ì •
  let systemPrompt = persona.baseSystem;
  if (style && style !== 'free') {
    systemPrompt = getStylePrompt(style, speaker, opponentLastMessage, topic, debateType);
  }

  // â”€â”€ ì •ì±… ì§€ì‹ë² ì´ìŠ¤ ì£¼ìž… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const kb = getKnowledge(topic, speaker);
  if (kb.myPosition || kb.conflicts.length > 0) {
    let kbText = '\n\nðŸ“š ì •ì±… ì§€ì‹ë² ì´ìŠ¤ (ì´ ë°ì´í„°ë¥¼ ë…¼ê±°ë¡œ ì ê·¹ í™œìš©í•˜ì„¸ìš”):';
    if (kb.myPosition) kbText += `\nâ€¢ ë‚´ í•µì‹¬ ìž…ìž¥: ${kb.myPosition}`;
    if (kb.conflicts.length > 0) {
      kbText += '\nâ€¢ í•µì‹¬ ìŸì :';
      kb.conflicts.forEach(c => {
        kbText += `\n  - [${c.ì£¼ì œ}] ë‚´ ìž…ìž¥: ${['ohsehoon','jangdh'].includes(speaker) ? c.ppp : c.dp} | ìˆ˜ì¹˜: ${c.ìˆ˜ì¹˜}`;
      });
    }
    if (kb.reversals.length > 0) {
      kbText += `\nâ€¢ ìƒëŒ€ ê³µê²© í¬ì¸íŠ¸ (êµ¬ì²´ì ìœ¼ë¡œ í™œìš©): ${kb.reversals.slice(0,2).join(' / ')}`;
    }
    kbText += '\nâš ï¸ ìœ„ ë°ì´í„°ì˜ ìˆ˜ì¹˜Â·ì‚¬ì‹¤ì„ ë°œì–¸ì— ì§ì ‘ ì¸ìš©í•˜ë˜, ê°™ì€ ë…¼ê±°ë¥¼ ë°˜ë³µí•˜ì§€ ë§ˆì„¸ìš”.';
    systemPrompt += kbText;
  }

  // â”€â”€ ë°˜ë³µ ê¸ˆì§€ ëª©ë¡ ì£¼ìž… (í˜„ìž¬ speakerê°€ ì´ë¯¸ ì‚¬ìš©í•œ ë…¼ì  ì¶”ì¶œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const myPastMessages = (recentHistory || []).filter(msg => msg.speaker === speaker);
  if (myPastMessages.length > 0) {
    const usedArgs = myPastMessages.map((m, i) => `${i + 1}. ${m.text}`).join('\n');
    systemPrompt += `\n\nðŸš« ë°˜ë³µ ì ˆëŒ€ ê¸ˆì§€ â€” ë„¤ê°€ ì´ë¯¸ í•œ ë°œì–¸ë“¤:\n${usedArgs}\nâš ï¸ ìœ„ ë°œì–¸ì— ë‚˜ì˜¨ ë…¼ë¦¬Â·ìˆ˜ì¹˜Â·ì‚¬ë¡€Â·í‘œí˜„ì€ ì´ë²ˆ ë°œì–¸ì— ë‹¨ í•˜ë‚˜ë„ ë°˜ë³µí•˜ì§€ ë§ˆë¼. ì™„ì „ížˆ ìƒˆë¡œìš´ ë…¼ê±°, ë‹¤ë¥¸ ì‚¬ë¡€, ìƒˆë¡œìš´ ìˆ˜ì¹˜ë¡œë§Œ ê³µê²©/ë°©ì–´í•˜ë¼. ê°™ì€ í‚¤ì›Œë“œë¼ë„ ë‹¤ë¥¸ ë§¥ë½Â·ê°ë„ì—ì„œ ì ‘ê·¼í•˜ë¼.`;
  }

  // â”€â”€ ëŒ€í™” ížˆìŠ¤í† ë¦¬ â†’ messages ë°°ì—´ë¡œ ì „ë‹¬ (LLM native ë°©ì‹, ì „ì²´ ê¸°ì–µ) â”€â”€â”€â”€â”€â”€â”€
  const SPEAKER_NAMES = {
    ohsehoon: 'ì˜¤ì„¸í›ˆ ì‹œìž¥',
    jungwono: 'ì •ì›ì˜¤ êµ¬ì²­ìž¥',
    jungcr: 'ì •ì²­ëž˜ ëŒ€í‘œ',
    jangdh: 'ìž¥ë™í˜ ëŒ€í‘œ',
  };

  const historyMessages = [];
  if (recentHistory && recentHistory.length > 0) {
    for (const msg of recentHistory) {
      // í˜„ìž¬ speaker ë°œì–¸ = assistant, ìƒëŒ€ë°© ë°œì–¸ = user
      const role = msg.speaker === speaker ? 'assistant' : 'user';
      historyMessages.push({
        role,
        content: msg.text, // ì´ë¦„ prefix ì œê±° â€” AIê°€ "ì´ë¦„:" íŒ¨í„´ ë”°ë¼í•˜ì§€ ì•Šë„ë¡
      });
    }
  }

  const finalUserMessage = opponentLastMessage
    ? `ìƒëŒ€ë°© ë°œì–¸: "${opponentLastMessage}" â€” ì´ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ìž…ìž¥ì„ ë§ì”€í•´ì£¼ì„¸ìš”.`
    : `"${topic}" ì£¼ì œë¡œ í† ë¡ ì„ ì‹œìž‘í•©ë‹ˆë‹¤. ì²« ë°œì–¸ì„ í•´ì£¼ì„¸ìš”.`;

  const messages = [...historyMessages, { role: 'user', content: finalUserMessage }];

  // SSE ìŠ¤íŠ¸ë¦¬ë°
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('X-Accel-Buffering', 'no');

  try {
    // OpenRouter API (OpenAI í˜¸í™˜ í¬ë§·)
    const openaiMessages = [
      { role: 'system', content: systemPrompt },
      ...messages,
    ];

    const apiAbort = new AbortController();
    const apiTimeout = setTimeout(() => apiAbort.abort(), 25000); // 25ì´ˆ íƒ€ìž„ì•„ì›ƒ

    const headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey.trim()}`,
    };
    if (!isOpenAI) {
      headers['HTTP-Referer'] = 'https://polichat.kr';
      headers['X-Title'] = 'PoliChat Debate';
    }

    const response = await fetch(`${apiBase}/chat/completions`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        model: isOpenAI ? 'gpt-4o-mini' : 'openai/gpt-4o-mini',
        max_tokens: 300,
        stream: true,
        messages: openaiMessages,
      }),
      signal: apiAbort.signal,
    });
    clearTimeout(apiTimeout);

    if (!response.ok) {
      const err = await response.text();
      console.error('[debate] OpenRouter API error:', response.status, err);
      res.write(`data: ${JSON.stringify({ error: `API error ${response.status}` })}\n\n`);
      res.end();
      return;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop() || '';

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if (!data || data === '[DONE]') continue;
        try {
          const json = JSON.parse(data);
          const delta = json.choices?.[0]?.delta;
          if (delta?.content) {
            res.write(`data: ${JSON.stringify({ text: delta.content })}\n\n`);
          }
        } catch {
          // skip malformed
        }
      }
    }

    res.write(`data: [DONE]\n\n`);
    res.end();
  } catch (e) {
    console.error('[debate] Error:', e.message);
    res.write(`data: ${JSON.stringify({ error: e.message })}\n\n`);
    res.end();
  }
}
