export const config = {
  supportsResponseStreaming: true,
  maxDuration: 60,
};

// ── 정당 정책 지식베이스 (4대 LLM 교차리서치 취합, 2026-02-19) ─────────────────
const POLICY_KB = {
  ppp: {
    핵심입장: {
      부동산: '10.15 대책 전면 철회 요구. 재건축/재개발 규제 완화·거래세 인하로 민간 공급 확대. 오세훈 354곳 정비구역 신규 지정. 분양가상한제·재초환제 폐지 주장. 신통기획 196곳 중 3곳만 승인된 현실 비판.',
      경제: '규제 완화·감세로 민간 주도 성장. 이재명 정부 210조 확장재정을 "재정 파탄" 비판. 2025 GDP 0.7% 성장률 하향(현대경제연구원), 실업률 3.3%(전년 2.8%). 법인세 전 구간 1%p 인상(2026 시행)에 "반시장 세금폭탄" 반대.',
      복지: '선별 복지, 재정 건전성 강조. 연금 자동조정장치 도입 주장. 모수개혁만으로 기금 고갈 8년 연장(2056→2064)에 불과하다고 비판.',
      안보: '한미동맹 최우선, 사드 추가배치·한미연합훈련 정상화. 이재명 정부 대북 확성기 중지(2025.6) 비판. 선제타격 능력 확보 주장.',
      사법: '검찰 수사 독립성 보장 주장. 이재명 정부의 검찰 수사권 박탈을 "정치적 사법장악" 비판. 공수처 무력화 우려.',
      AI: 'AI 3대 강국 목표, 민간 주도 AI 생태계. AI R&D 5조원 확대(2025 대선 공약). 민간 AI 투자 20조원 유치. 정부 공공 투자 비효율 비판.',
      교육: '경쟁 중심 공교육 강화. 사교육비 29조 시대 비판. 킬러문항 유지로 변별력 강조. 교육자유특구 추진.',
      연금: '보험료 13%·소득대체율 43% 여야 합의(2025.3) 동의. 자동조정장치 도입 강력 주장. 기금 고갈 시점 추가 연장 필요.',
      선거제도: '준연동형 비례대표제 폐지 또는 병립형 환원 주장. 위성정당 금지법 회의적. 소선거구 중심 유지 선호.',
      언론: '언론 자유 보장, 국가 개입 최소화. 공영방송 국가예산 연계에 반대. 민주당의 언론장악 우려 비판.',
      기업세금: '법인세 인하·상속세 대폭 완화(50%→40%). 법인세 2026 전 구간 1%p 인상 반대. 3000억 초과 구간 25% "글로벌 감세 경쟁 역행". 유산취득세 전환 지지.',
      대북외교: '대북 강경, 방위력 강화. 확성기 방송 중지를 "안보 타협" 비판. 캠프데이비드 한미일 합의 지속 주장.',
      한미동맹: '한미동맹 최우선. 인도태평양 전략 동참. 트럼프 관세에 전략적 대화 플랫폼 구축. 방위비 분담금 협상 대응.',
    },
    공약파기: [
      '5년 250만호 공급 목표 미달 (실제 공급량 대폭 부족)',
      '여성가족부 폐지 미이행',
      '사드 추가배치 무산',
      '주69시간제 추진→여론 반발로 철회',
      '근로시간저축계좌제 미이행',
      '병사월급 200만원→실제 봉급 125만원(적금 포함 방식으로 변경)',
      '대통령실 광화문 이전→용산 이전으로 변경',
      '촉법소년 연령기준 현실화 미이행',
      '화석연료 발전비중 40%대 감축 목표 미달',
      '근로능력없는 가구 월10만원 추가지급 미이행',
      '주식양도소득세 폐지 미완',
    ],
    이행률: '윤석열 정부 공약 이행률 35.3% (136개 중 48개 완료, 16개 변경, 72개 파기 — 뉴스톱 윤석열미터)',
    공격포인트: [
      '이재명 기본소득 공약 집권하자마자 철회 — 연 100만원 보편기본소득 2022 핵심 공약이 2025 대선에서 완전 삭제, 대국민 사기',
      '탈원전 주장하다 180도 전환 — 2022년 "감원전" 입장에서 2025년 "원전 유지·활용"으로 전환, 정책 일관성 제로',
      '10.15 대책으로 서울 전역 3중 규제(토허구역+투기과열지구+조정대상지역) — 공급 위축으로 집값 불안 심화',
      'LH 부채 160조 이상인데 기본주택 100만호? 재정 파탄 자초하는 공약',
      '장동혁 대표 6채 보유 거론(2026.2 설전) — 다주택자 규제하면서 본인들은 다주택, 이중잣대',
      '법인세 전 구간 1%p 인상(2026 시행) — 중소기업까지 세금폭탄, 글로벌 감세 추세 역행',
      '2025 GDP 성장률 0.7% 하향(현대경제연구원) — 이재명 정부 출범 후 경기침체 가속',
      '경제 노선 우클릭 — 2022년 "재벌개혁·공정경제"에서 2025년 "AI 산업 육성·210조 투자"로 완전 전환, 진보 정체성 상실',
      '부동산 정책 혼선 — 2022년 재건축 완화 검토→집권 후 10.15 대책으로 초강력 규제, 일관성 없음',
      '확장재정 5년 210조 투자 — 국가채무 급증, 미래세대 부담 전가',
    ],
  },
  dp: {
    핵심입장: {
      부동산: '10.15 대책(서울 전역 3중 규제). 기본주택 시범단지 2026 상반기 입주자 모집. 전세사기특별법 2027.5까지 연장. 다주택자 양도세 중과 유예 2026.5 종료. 부동산감독원 출범 추진.',
      경제: 'AI 3대 강국 도약. 5년간 210조 추가 재정투자. 2026 성장률 2% 목표. 법인세 1%p 인상은 윤석열 부자감세 정상화. 반도체·AI·녹색전환 전략산업 집중.',
      복지: '기본이 튼튼한 사회 — 123대 국정과제 중 37개(최다). 저출생 대응, 공공의료 강화, 보편+맞춤형 복지. 기초연금 2026년 349,700원.',
      안보: '대북 확성기 중지(2025.6). 국익 중심 실용외교. 평화공존과 번영의 한반도. 한미동맹 유지+균형외교(미·중 사이).',
      사법: '검찰 수사권 조정 유지. 공수처 강화. 12.3 내란 청산. 검찰개혁 완수.',
      AI: 'AI 대전환 국정 목표. 2026 AI 예산 10.1조원(전년比 30%↑). AI 인재 1.1만명 양성. AI 기본법 2026.1 시행. AI 윤리 가이드라인 발표.',
      교육: '기본교육 책임제, AI 보편교육. 유아 무상교육 4세 확대. 지방대학 육성 5조원. 2022 개정 교육과정 적용.',
      연금: '18년 만의 연금개혁 성과. 보험료 9%→13%(2026년 9.5%부터 매년 0.5%p씩, 2033년 13% 도달). 소득대체율 41.5%→43%. 국가 지급보장 명문화. 기금 소진 2056→2064년.',
      선거제도: '위성정당 방지법 입법 추진(이재명 대선 공약). 연동형 비례대표제 취지 살려 다당제 활성화. 2026 지방선거 6월 3일.',
      언론: '공영방송 투명성·공공책임 강화. KBS 공적 자금 지원 10% 확대. 허위정보·가짜뉴스 대응 입법.',
      기업세금: '법인세 1%p 인상은 2022 이전 수준 환원(증세 아닌 정상화). 상속세 유산취득세 전환(2028 시행 목표). 배우자공제 18억 확대 검토. 전면적 세율 인하 반대.',
      대북외교: '남북대화 재개. 확성기 방송 중지(2025.6). 다자간 평화회담 추진. 경제협력으로 비핵화 유도.',
      한미동맹: '한미동맹 유지하되 중국과 실용적 관계. 국익 중심 균형외교. 방위비 분담 8% 인상 협상. 캠프데이비드 합의 선별적 계승.',
    },
    입장변화: [
      '기본소득 철회: 2022 "전 국민 연 100만원 보편기본소득"→2025 대선 공약에서 완전 삭제 (재정 현실성·중도층 확보)',
      '탈원전 철회: 2022 "탈원전·감원전"→2025 "원전 유지·활용" 전환 (에너지 안보·AI 전력수요)',
      '경제 우클릭: 2022 "재벌개혁·공정경제·분배 성장"→2025 "혁신경제·AI 3대 강국·210조 투자" (성장 중심 전환)',
      '외교: 2022 "종전선언·한반도 평화경제"→2025 "국익 중심 실용외교" (미중 갈등 심화 반영)',
      '부동산: 2022 재건축 완화 검토→집권 후 10.15 대책으로 초강력 규제 선회',
    ],
    공격포인트: [
      '국민의힘 공약 이행률 35.3%, 72개 파기 — 뉴스톱 윤석열미터 기준, 국민 기만의 역사',
      '12.3 비상계엄 선포(2024.12.3)→헌재 탄핵 인용(2025.4.4) — 민주주의 파괴한 당이 정권 자격 있나',
      '5년 250만호 공급 공약 완전 실패 — 수도권 130~150만호 목표 미달, 집값 폭등 방치',
      '법인세 25→22% 인하했는데 투자 안 늘고 유보금만 증가 — 감세로 5년간 세수 3.9조 감소 초래',
      '상속세 인하 = 초부유층 특혜 — OECD 평균 15%지만 한국 부의 집중도 감안하면 인하 불가',
      '오세훈 재개발로 강남만 집값 상승, 서민은 내몰림 — 신통기획 196곳 중 3곳만 승인',
      '병사월급 200만원 공약→실제 봉급 125만원, 적금 포함 꼼수 — 청년 기만',
      '주69시간제 추진으로 노동자 건강권 위협→여론 반발에 철회 — 정책 역량 부재',
      '윤석열 정부 시절 부자감세로 세수 펑크 — 법인세·상속세 개정 5년 세수효과 -3조8,833억원',
      '의대 정원 2000명 확대 강행(2024)→의정갈등 촉발 — 국민 의료공백 자초',
    ],
  },
  seoul: {
    ohsehoon: {
      재개발: '354곳 정비구역 신규 지정. 강북르네상스 2.0: 16조원 투자(2026.02.19 발표). 신통기획 196곳 추진(3곳 승인). 10.15 대책에 정면 반발 — "부동산 정책 포기했나"(2026.01.19 페이스북). 종묘 앞 초고층 재개발 갈등(2025.12.17).',
      교통: 'GTX-A 수서~동탄 개통(2024.3), 파주~서울역(2024.12). 리버버스·UAM 추진. 준공영제 유지하나 연간 5,000억 적자. 2026.1 시내버스 파업→기본급 2.9% 인상 타결, 재정부담 8,000억까지 증가 전망.',
      환경: '2050 탄소중립 로드맵: 2026년 -30%, 2030년 -40%(2005 대비). 공공건물 ZEB 의무화. 태양광 보조금 사업 중단→민간 주도 전환. 에너지 협동조합 지원 폐지.',
      청년: '청년안심주택(시세 30~85%). 청년월세지원 2025년 3차까지 완료, 2026.4 이후 공고 예정. 용산국제업무지구 8,000호 공급.',
      소상공인: '힘보탬 프로젝트(전주기 지원). 자영업자 안심통장. 서울배달+땡겨요 공공배달앱. 임대료 최대 30% 인하(점포당 연간 최대 2,000만원).',
      복지: '약자와의 동행 — 선별복지. 2026 예산 51조5,060억(역대 최대, +7%). 4대 취약계층에 2조7,906억 민생 패키지. 무상급식 반대 주민투표 강행 전력(투표율 미달 개표 불가).',
      행정: 'S-Map 디지털트윈(서울 전체 3D 가상). 스마트시티 9개 분야. 2026 생성형 AI CCTV 관제 시범사업.',
      치안: 'CCTV 약 17만대(2026 지능형 100% 전환 목표). 노후 1만5,000대 교체 + 일반 7만대 AI 탑재. 범죄예방 강화구역 + 스마트 보안등 + 헬프미 안심벨.',
      관광: 'Seoul, My Soul 브랜드(2023.8 론칭). 2025 방한객 1,870만명 역대 최다. 서울비전 2030 글로벌 Top5 도시. 2040 서울플랜 수변공간 재편.',
      브랜딩: '동행·매력 특별시 서울. Seoul, My Soul. 서울숲 국제정원박람회(2026). K-푸드로드 25억 신규사업.',
    },
    jungwono: {
      재개발: '젠트리피케이션 방지 전국 최초 도입(2015 성동구). 3자 상생협약(건물주·임차인·구청). 환산보증금 상한선 폐지 주장(현 9억 이상 시 보호 불가). 지방정부협의회 제5기 회장(2025.3). 성수동 핫플레이스+원주민 보호 성공 모델.',
      교통: '준공영제 근본적 재검토 주장. 공공버스 투입 제안(성동구 무료셔틀 10대 운영 경험). 철도 중심 대중교통 재편. 마을버스 노선 확대.',
      환경: '생활폐기물 5년 연속 감량(2020 대비 9,000톤 감축). 2027년 20% 감량 목표. 전국 최초 고시원 친환경 보일러 교체(2026.2). 탄소중립 녹색성장 기본계획 수립.',
      청년: '전국 최초 반지하 전수조사(2022). 위험거처 개선사업 4년 추진. 전입 1인가구 청년 생필품 지원. 어학·자격시험 응시료 지원. 청년 행정체험단 60명.',
      소상공인: '전국 최초 젠트리피케이션 방지책(2015). 환산보증금 기준 폐지 주장. 전국 47개 지자체 참여 협의회 주도. 젠트리피케이션 입법토론회(2024.12).',
      복지: '세금이 아깝지 않은 서울 — 보편+맞춤형 복지. 교육·보육·복지에 예산 54% 집중. 2026 예산 7,642억(+5.89%). 우리동네돌봄단 2024년 3,926건 지원. 원플러스원 민관 연대형 복지.',
      행정: '스마트 포용 도시. OECD 스마트 쉼터 우수사례. 2020 UN 공공행정상. 전국 지자체 혁신평가 대통령상. 15분 도시·30분 출퇴근 구조.',
      치안: 'AI 지능형 선별 관제 시스템. 스마트 횡단보도·스쿨존 보행자 감지→교통사고 감소. 반지하 전수조사(2022)로 수해·화재·낙상 위험 제거.',
      관광: '성수동 문화예술 클러스터 성공. 젠트리피케이션 방지하면서 로컬 브랜드 구축. 시민 일상 문화 향유 중심.',
      브랜딩: '멋지고 행복하고 편안한 서울. 유니세프 아동친화도시 인증(2018)·상위단계(2022). ESG 보고서 지자체 최초 2년 연속 발간. 진정성 있는 도시 브랜딩.',
      여론조사: '2026.01 여론조사: 정원오 50.5% vs 오세훈 40.3%',
    },
  },
  leejeon: {
    leejunseok: {
      핵심입장: {
        부정선거: '부정선거론은 비과학적 허위 음모론. 2020 총선 이후 선거 무효·당선 무효 소송 126건 중 단 한 건도 인정 안 됨. 전한길을 허위사실 유포 명예훼손으로 고소(2026.1.30).',
        보수정체성: '합리적 보수·세대교체론. 작은 정부, 규제타파, 연금개혁. 강성 보수는 보수를 망치는 반지성주의. 개혁신당 창당으로 제3지대 정치 추구.',
        젠더: '여성가족부 폐지 후 인권부 개편. 여성희망복무제(사병 자원입대) 제안. 경찰·해경·소방·교정 공무원 남녀 병역 의무화.',
        탄핵: '윤석열 비상계엄은 민주주의 파괴. 12.3 사태는 국회 해산권이 있었으면 막을 수 있었다. 2026.2.19 내란 1심 유죄는 당연한 결과.',
        정치개혁: '19개 부처→13개 통합 3부총리제. 대통령 권한 축소. 기초의원 정당공천제 폐지. 기탁금 0원화. 양당 구도 타파.',
      },
      공격포인트: [
        '전한길 부정선거 주장 영상 증거 남겨놓고 "그런 말 한 적 없다" 발뺌 — 자기 채널에 증거 그대로',
        'TV조선도 비논리적·비과학적 발언 팩트체크 불가로 토론 중계 거부(2026.2.13)',
        '전한길 100억 건국펀드: 최소 1000만원 모금, 윤어게인 후 상환 약속 — 불법 정치자금 모금 소지',
        '3권분립 폐지 + 국호 변경 주장 — 헌정질서 파괴 공개 선동. 보수층에서도 황당 반응',
        '국민의힘 입당조차 거부당함 — 자기가 지지하는 당에서도 안 받아줌',
        '이재명 지지자에게 "강간 당하고 팔려가라" 막말(2025.11.10) — 대통령 비서실장도 조처 언급',
        '노량진 섹터디 성희롱 발언 캡처 — 카페에서 삭제 시도',
        '원래 노사모(진보) 출신 → 보수 전향 일관성 부족',
      ],
      약점: [
        '2013년 성 접대 의혹(공소시효 만료 공소권 없음 — 무죄 아님)',
        '젓가락 발언 논란(2025.5.27 대선 토론) — 지지율 15%→8.34% 하락 직접 원인',
        'SW마에스트로 병역 특혜 의혹',
        '싸가지 없다는 이미지, 거만한 태도',
        '대선 291만표(8.34%) 3위 패배',
      ],
    },
    jeonhangil: {
      핵심입장: {
        부정선거: '제21대 총선과 대선은 부정선거. 선관위 강제 수사 필요. 결정적 증거 10억 사례금 제안. 이준석 동탄 당선도 부정선거라 주장.',
        보수정체성: '강성 친윤, 진짜 보수. 윤석열 중심 제2건국. 이준석은 보수 분열 초래한 내부 총질러이자 위장 보수.',
        젠더: '보수적 전통 가족관 중시. 급진 페미니즘 반대.',
        탄핵: '윤석열 탄핵 반대. 비상계엄은 선관위 부정선거 수사 불가피한 조치. 1심 유죄(2026.2.19 무기징역)에 충격, 부당판결 주장.',
        제2건국: '3권분립 폐지, 행정·입법·사법·공수처 해체 후 재건국. 100억 건국펀드(1000만~1억 모금). 발해·고구려 고토 회복.',
      },
      공격포인트: [
        '이준석 2013년 성 접대 의혹 — 공소시효 만료 공소권 없음이지 무죄가 아니다',
        '이준석 무고 혐의 — 의혹 제기자 고소했다가 역으로 무고죄 피소, 항고 심리 중',
        '이준석에게 의원직 걸어라 도발 — 진정성 시험',
        '이준석 젓가락 발언(2025.5.27) — 대선 토론에서 성폭력 묘사, 대통령 후보 자격 의문',
        '이준석 SW마에스트로 병역 특혜 — 공정 말하면서 본인 병역은 특혜',
        '국민의힘 탈당한 배신자 — 보수 분열의 원흉',
        '하버드 학벌 내세워 국민 가르치려 드는 꼰대',
        '대선 291만표 8.34% 3위 참패 — 국민이 심판한 것',
      ],
      약점: [
        '부정선거 음모론 과학적 근거 부재 — TV조선도 팩트체크 불가로 거부',
        '원래 노사모(진보) 출신 전향 일관성 부족',
        '본명 전유관으로 몰래 국민의힘 입당 시도 — 입당 거부당함',
        '이재명 지지자 강간·팔려가라 막말(2025.11)',
        '3권분립 폐지·발해 수복 등 비현실적 주장',
        '윤석열 내란 1심 유죄(2026.2.19) — 핵심 논거 약화',
        '노량진 섹터디 성희롱 발언',
      ],
    },
    핵심쟁점: [
      { 주제: '부정선거론', 이준석: '126건 소송 전부 기각, 비과학적 허위 음모론. 명예훼손 고소.', 전한길: '선관위 의혹 실체 있다. 결정적 증거 10억 사례금 제안.', 수치: '소송 126건 0건 인용. TV조선 심의 부적격 판정(2026.2.13)' },
      { 주제: '보수 정체성', 이준석: '합리적 보수·세대교체. 강성 보수는 반지성주의로 보수 자멸.', 전한길: '진짜 보수는 윤석열 옹호·부정선거 척결. 이준석은 위장 보수.', 수치: '이준석 대선 8.34%, 전한길 유튜브 53만+' },
      { 주제: '윤석열 탄핵', 이준석: '12.3 비상계엄은 민주주의 파괴. 내란 유죄는 당연.', 전한길: '탄핵 부당, 비상계엄은 불가피. 1심 무기징역 충격.', 수치: '2026.2.19 내란 1심 무기징역 선고' },
      { 주제: '젠더·페미니즘', 이준석: '여가부 폐지→인권부 개편. 남녀 공정 병역. 젓가락 발언 해명.', 전한길: '전통 가족관. 이준석 젓가락 발언은 여성 비하 본색.', 수치: '젓가락 발언 후 지지율 15%→8.34% 하락' },
      { 주제: '이준석 의혹', 이준석: '성 접대 의혹은 윤핵관의 조작. SW마에스트로는 합법.', 전한길: '공소시효 만료≠무죄. 병역 특혜 해명 불충분.', 수치: '2022.9.20 공소권 없음 종결. SW마에스트로 관리지침 위반 의혹' },
      { 주제: '전한길 막말', 이준석: '이재명 지지자 강간 발언, 노량진 성희롱 — 정치인 자격 없음.', 전한길: '정치 탄압이고 맥락 왜곡. 표현의 자유.', 수치: '2025.11.10 YTN·헤럴드 보도. 대통령 비서실장 조처 언급' },
    ],
  },
  핵심쟁점: [
    // ── 전국 쟁점 ──
    { 주제: '부동산 규제', ppp: '규제가 공급 위축→집값 상승. 민간 재건축 활성화. 10.15 대책 철회.', dp: '투기 억제 없으면 집값 더 오름. 10.15 대책이 정답. 다주택자 규제 유지.', 수치: '다주택자 양도세 중과 유예 2026.5 만료. 서울 전역+경기12곳 3중규제 시행' },
    { 주제: '경제·민생', ppp: '확장재정이 국가채무만 늘리고 기업투자 위축. 규제완화·감세로 민간 성장.', dp: '윤석열 부자감세 정상화. 적극재정으로 2026 성장률 2% 달성. 전략산업 투자.', 수치: '2025 GDP 0.7%(현대경제연구원). 2026 목표 2%. 법인세 최고 24→25%(2026)' },
    { 주제: '기업·세금', ppp: '법인세 인상은 글로벌 감세 역행. 상속세 50%→40% 인하. 유산취득세 전환.', dp: '감세해도 투자 안 늘고 유보금만 증가. 법인세 1%p는 정상화. 상속세 전면 인하 반대.', 수치: '법인세 최고 25%(2026). 상속세 최고 50%(OECD 최고). 윤석열 감세 5년 세수 -3.9조' },
    { 주제: '연금·복지', ppp: '모수개혁만으론 기금 고갈 8년 연장뿐. 자동조정장치·구조개혁 필요.', dp: '18년 만의 연금개혁 성과. 국가 지급보장 명문화. 자동조정장치는 연금 삭감 장치.', 수치: '보험료 9→13%(2033). 소득대체율 43%. 기금 소진 2056→2064년. 기금 1,100조' },
    { 주제: '선거제도', ppp: '준연동형 폐지 또는 병립형 환원. 위성정당 금지법 회의적.', dp: '위성정당 방지법 입법. 연동형 비례대표제 취지 살려 다당제 활성화.', 수치: '비례 47석(300석 중). 연동적용 30석. 2026 지방선거 6.3' },
    { 주제: '검찰·사법', ppp: '검찰 수사 독립성 보장. 이재명 정부의 검찰 무력화 비판.', dp: '검찰개혁 완수. 공수처 강화. 12.3 내란 청산. 검찰권 남용 방지.', 수치: '검찰-경찰 수사권 조정 2026 시행. 공수처 수사 사건수 증가 추세' },
    { 주제: '언론·표현', ppp: '언론 자유 보장, 국가 개입 최소화. 공영방송 정부 종속 우려.', dp: '공영방송 공적 책임·투명성 강화. 허위정보 대응 입법.', 수치: '공공서비스 방송 콘텐츠 60% 목표(2026). KBS 공적자금 10% 증가' },
    { 주제: '한미동맹·트럼프', ppp: '한미동맹 최우선. 인도태평양 전략 동참. 방위비 분담 적극 협상.', dp: '한미동맹 유지+균형외교. 국익 중심 실용적 관계. 트럼프 관세 외교적 해결.', 수치: '방위비 분담금 2026 15% 증가 전망. 트럼프 관세 한국 산업 영향' },
    { 주제: '대북·외교', ppp: '대북 강경. 방위력 강화. 확성기 방송 재개 주장.', dp: '남북대화 재개. 확성기 중지(2025.6). 다자간 평화회담 추진.', 수치: '국방예산 8% 증가. 확성기 방송 중지 2025.6 시행' },
    { 주제: 'AI·디지털', ppp: 'AI R&D 5조 확대. 민간 주도 20조 유치. 정부 AI 예산 비효율 비판.', dp: 'AI 예산 10.1조(+30%). AI 인재 1.1만명. AI 기본법 2026.1 시행.', 수치: 'AI 시장 2026년 50조. AI 활용기업 40%(OECD 상위). AI 예산 10.1조' },
    { 주제: '교육', ppp: '경쟁 중심 공교육, 사교육비 절감. 변별력 유지. 지방대 육성 부족 비판.', dp: '기본교육 책임제, AI 보편교육. 유아 무상교육 4세 확대. 지방대 5조 투자.', 수치: '사교육비 29조(2025 역대 최고). 교육예산 90조. AI 교육 1조' },
    { 주제: '기본소득', ppp: '집권하자마자 철회, 공약 사기.', dp: '재정 현실 반영한 현명한 노선 수정.', 수치: '연 100만원→완전 철회' },
    { 주제: '원전', ppp: '탈원전 주장하다 180도 전환, 일관성 없음.', dp: '에너지 현실주의. AI·반도체 전력수요 급증 대응.', 수치: '현재 여야 모두 원전 유지 수렴' },
    { 주제: '재건축초과이익환수', ppp: '폐지해야. 공사비 급등 시대에 사업성 악화.', dp: '개발이익 사유화 안돼. 사회 환원 당연.', 수치: '평균 부담금 3~5억원, 조합원 반발 증가' },
    { 주제: '상속세', ppp: '최고세율 50% 세계 최고, 기업 경영권 위협. OECD 평균 15%.', dp: '부자 감세, 부의 대물림 고착화. 공제 확대는 검토하되 세율 인하 반대.', 수치: '한국 50% vs OECD 평균 15%. 유산취득세 2028 전환 목표' },
    { 주제: '예산', ppp: '지역화폐 예산 반대, 재정 건전성 우선.', dp: '민생 예산 증액 필수.', 수치: '2026 예산 728조(+3.2%)' },
    // ── 서울 쟁점 ──
    { 주제: '서울 재개발', ppp: '354곳 정비구역 지정, 강북르네상스 2.0 16조 투자. 10.15 대책이 재정비 선순환 끊었다.', dp: '신통기획 196곳 중 3곳만 승인, 실적 부풀리기. 개발이익 사회환원 필요.', 수치: '강북르네상스 16조(2026.02.19). 신통기획 승인율 1.5%' },
    { 주제: '서울 젠트리피케이션', ppp: '시장 자율 해결. 임대료 30% 인하 지원으로 소상공인 보호.', dp: '성동구 2015 전국 최초 방지책. 상생협약 모델 서울 확대. 환산보증금 상한선 폐지.', 수치: '환산보증금 9억 이상 시 보호 불가. 47개 지자체 협의회' },
    { 주제: '서울 교통', ppp: 'GTX-A 전구간 연결(2026.6 예정). 리버버스·UAM. 준공영제 유지.', dp: '준공영제 근본 재검토. 공공버스 도입. 철도 중심 재편.', 수치: '준공영제 연간 5,000억 적자. 파업 후 재정부담 8,000억 전망. 버스 7,000대' },
    { 주제: '서울 환경', ppp: '2050 탄소중립. 공공건물 ZEB. 다양한 에너지원 전환.', dp: '생활폐기물 5년 연속 감량(9,000톤). 에너지 취약계층 중심 녹색 전환.', 수치: '2026 -30% 감축. 온실가스 95% 건물·교통·폐기물' },
    { 주제: '서울 청년', ppp: '청년안심주택(시세 30~85%). 용산 8,000호. 대규모 공급 중심.', dp: '반지하 전수조사(2022 전국 최초). 생필품·응시료 지원. 생활밀착형.', 수치: '용산 8,000호. 청년월세지원 2026.4 공고' },
    { 주제: '서울 소상공인', ppp: '힘보탬 프로젝트. 안심통장. 배달앱. 임대료 30% 인하(연 최대 2,000만).', dp: '젠트리피케이션 방지 2015 최초. 상생협약. 환산보증금 폐지.', 수치: '국유재산 25,996건·1,383억 지원. 소상공인 임대료 최대 2,000만' },
    { 주제: '서울 복지', ppp: '약자와의 동행(선별). 51조 역대 최대 예산. 4대 취약계층 2.8조.', dp: '세금이 아깝지 않은 서울(보편). 교육·복지 54% 투자. 돌봄단 3,926건.', 수치: '서울시 51.5조 vs 성동구 7,642억. 민생 패키지 2.8조' },
    { 주제: '서울 행정', ppp: 'S-Map 디지털트윈. 생성형 AI 관제. 기술 중심 스마트시티.', dp: '스마트 포용 도시. OECD·UN 인정. 15분 도시. 사람 중심.', 수치: 'UN 공공행정상(2020). OECD 스마트 쉼터 우수사례' },
    { 주제: '서울 치안', ppp: 'CCTV 17만대 지능형 100% 전환(2026). AI 관제. 스마트 보안등.', dp: 'AI 선별 관제. 스마트 횡단보도·스쿨존. 반지하 위험 제거.', 수치: '노후 1.5만대 교체. 7만대 AI탑재. CCTV 범죄 8.5~46% 감소' },
    { 주제: '서울 관광', ppp: '2025 방한객 1,870만명 역대 최다. Seoul My Soul. 글로벌 Top5.', dp: '시민 일상 문화 중심. 성수동 문화클러스터. 로컬 콘텐츠.', 수치: '방한 1,870만명. 문체부 7.9조(+11.2%). K-푸드로드 25억' },
    { 주제: '서울 교육격차', ppp: '교육청 2026 예산 11.47조. 기초학력 158억. AI 교육 투자.', dp: '구 예산 54% 교육·복지 집중. 교육보조금 130억. 아동친화도시.', 수치: '교육청 11.47조. 교부금 4,000억 감소. 인건비 3,500억 증가' },
    { 주제: '서울 브랜딩', ppp: 'Seoul My Soul(2023.8). 서울비전 2030. 서울숲 국제정원박람회.', dp: '성수동 성공모델. ESG 보고서 2년 연속. 유니세프 아동친화도시.', 수치: '브랜드 론칭 2023.8. 방한객 1,870만명' },
    { 주제: '강남북격차', ppp: '강북르네상스 2.0으로 16조 투자. 354곳 정비구역으로 균형발전.', dp: '개발 중심으론 격차 해소 불가. 생활인프라·복지·교육 격차 해소 우선.', 수치: '강북르네상스 16조(2026.02.19)' },
    { 주제: '서울 주거정책', ppp: '규제 완화로 민간 공급 확대. 재건축·재개발 활성화가 최우선.', dp: '공공주택 공급 확대. 기본주택 시범단지. 투기 억제+서민 주거 안정.', 수치: '서울 30만호 공급 계획(10.15 대책). 청년안심주택 시세 30~85%' },
  ],
};

function getKnowledge(topicLabel, speaker) {
  // ── leejeon 전용 지식베이스 ──
  if (['leejunseok', 'jeonhangil'].includes(speaker)) {
    const lj = POLICY_KB.leejeon;
    const myKb = speaker === 'leejunseok' ? lj.leejunseok : lj.jeonhangil;

    // 주제별 핵심입장 매칭
    const posKey = /부정선거/.test(topicLabel) ? '부정선거'
      : /보수.*정체|정체.*보수/.test(topicLabel) ? '보수정체성'
      : /젠더|페미/.test(topicLabel) ? '젠더'
      : /탄핵|윤석열/.test(topicLabel) ? '탄핵'
      : /개혁|기득권/.test(topicLabel) ? '정치개혁'
      : /건국|제2건국/.test(topicLabel) ? '제2건국'
      : null;

    const myPosition = posKey ? myKb.핵심입장[posKey] : null;

    // 관련 쟁점 필터
    const conflicts = lj.핵심쟁점.filter(c => {
      if (/부정선거/.test(topicLabel)) return /부정선거/.test(c.주제);
      if (/보수/.test(topicLabel)) return /보수/.test(c.주제);
      if (/탄핵|윤석열/.test(topicLabel)) return /탄핵/.test(c.주제);
      if (/젠더|페미/.test(topicLabel)) return /젠더/.test(c.주제);
      if (/의혹|스캔들/.test(topicLabel)) return /이준석 의혹/.test(c.주제);
      if (/막말|논란/.test(topicLabel)) return /전한길 막말/.test(c.주제);
      return false;
    }).slice(0, 3);

    // 쟁점을 leejeon 형식으로 변환
    const conflictsFormatted = conflicts.map(c => ({
      주제: c.주제,
      ppp: speaker === 'leejunseok' ? c.이준석 : c.전한길,
      dp: speaker === 'leejunseok' ? c.전한길 : c.이준석,
      수치: c.수치,
    }));

    const opponentKb = speaker === 'leejunseok' ? lj.jeonhangil : lj.leejunseok;
    return {
      myPosition,
      seoulContext: null,
      attackPoints: myKb.공격포인트.slice(0, 4),
      conflicts: conflictsFormatted,
      reversals: opponentKb.약점 || [],
    };
  }

  const pppSpeaker = ['ohsehoon', 'jangdh'].includes(speaker);
  const isSeoulSpeaker = ['ohsehoon', 'jungwono'].includes(speaker);
  const kb = pppSpeaker ? POLICY_KB.ppp : POLICY_KB.dp;

  const isHousing = /부동산|재건축|재개발|주거|주택|전세|임대|젠트리|강남/.test(topicLabel);
  const isEconomy = /경제|민생|예산|세금|상속|물가|기업/.test(topicLabel);
  const isEnv = /환경|탄소|에너지|원전/.test(topicLabel);
  const isWelfare = /복지|기본소득|연금|의료|저출생|돌봄/.test(topicLabel);
  const isSecurity = /안보|북한|한미|외교|국방|대북|동맹|트럼프/.test(topicLabel);
  const isAI = /AI|디지털|인공지능|기술/.test(topicLabel);
  const isEducation = /교육|사교육|학교|대학|입시/.test(topicLabel);
  const isPension = /연금|보험료|소득대체/.test(topicLabel);
  const isElection = /선거|비례|위성정당|투표/.test(topicLabel);
  const isJudicial = /검찰|사법|공수처|수사|내란|계엄/.test(topicLabel);
  const isMedia = /언론|방송|표현|가짜뉴스|KBS/.test(topicLabel);
  const isTransport = /교통|버스|GTX|지하철|파업/.test(topicLabel);
  const isYouth = /청년|반지하|월세/.test(topicLabel);
  const isSmallBiz = /소상공인|자영업|골목|배달|임대료/.test(topicLabel);
  const isSafety = /치안|안전|CCTV|범죄/.test(topicLabel);
  const isTourism = /관광|방한|브랜딩|문화/.test(topicLabel);

  // 관련 쟁점 필터
  const relevantConflicts = POLICY_KB.핵심쟁점.filter(c => {
    const t = c.주제;
    if (isHousing) return /부동산|재건축|주거|강남|젠트리/.test(t);
    if (isEconomy) return /경제|기업|세금|기본소득|상속|예산/.test(t);
    if (isEnv) return /원전|환경/.test(t);
    if (isWelfare) return /연금|복지/.test(t);
    if (isSecurity) return /한미|대북|외교|동맹/.test(t);
    if (isAI) return /AI|디지털/.test(t);
    if (isEducation) return /교육/.test(t);
    if (isPension) return /연금/.test(t);
    if (isElection) return /선거/.test(t);
    if (isJudicial) return /검찰|사법/.test(t);
    if (isMedia) return /언론/.test(t);
    if (isTransport) return /교통/.test(t);
    if (isYouth) return /청년/.test(t);
    if (isSmallBiz) return /소상공인|젠트리/.test(t);
    if (isSafety) return /치안/.test(t);
    if (isTourism) return /관광|브랜딩/.test(t);
    return false;
  });

  // 핵심입장 매칭
  const positionKey = isHousing ? '부동산'
    : isEconomy ? '경제'
    : isEnv ? null
    : isWelfare ? '복지'
    : isSecurity ? '안보'
    : isAI ? 'AI'
    : isEducation ? '교육'
    : isPension ? '연금'
    : isElection ? '선거제도'
    : isJudicial ? '사법'
    : isMedia ? '언론'
    : null;

  let myPosition = positionKey ? kb.핵심입장[positionKey] : null;

  // 서울 스피커 추가 지식
  let seoulContext = null;
  if (isSeoulSpeaker) {
    const seoulKb = speaker === 'ohsehoon' ? POLICY_KB.seoul.ohsehoon : POLICY_KB.seoul.jungwono;
    const seoulKey = isHousing ? '재개발'
      : isTransport ? '교통'
      : isEnv ? '환경'
      : isYouth ? '청년'
      : isSmallBiz ? '소상공인'
      : isWelfare ? '복지'
      : isSafety ? '치안'
      : isTourism ? (seoulKb.관광 ? '관광' : '브랜딩')
      : isEducation ? (seoulKb.브랜딩 ? '브랜딩' : null)
      : null;
    if (seoulKey && seoulKb[seoulKey]) {
      seoulContext = seoulKb[seoulKey];
    }
    // 행정 fallback
    if (!seoulContext && /행정|스마트|디지털/.test(topicLabel)) {
      seoulContext = seoulKb.행정;
    }
  }

  return {
    myPosition,
    seoulContext,
    attackPoints: kb.공격포인트.slice(0, 4),
    conflicts: relevantConflicts.slice(0, 3),
    reversals: pppSpeaker ? POLICY_KB.dp.입장변화 : POLICY_KB.ppp.공약파기
  };
}

// 모듈 최상위에 정의 — getStylePrompt에서도 접근 가능
const CURRENT_CONTEXT = `⚠️ 시간 기준 (최우선 규칙): 현재는 2026년 2월이다. 이재명 대통령 집권 중(2025년 취임). 12.3 계엄 사태 이후 정치 지형 재편. 절대 금지: "2023년 기준", "2022년 기준" 등 과거 수치를 현재인 것처럼 말하는 것. 수치 인용 시 2025~2026년 현재 기준임을 전제하거나, 정확한 수치를 모르면 구체적 숫자 대신 방향성으로 답변하라.

⚠️ 발언 형식 (절대 금지): 절대로 "이름:" "이름 직함:" "나는" 같은 자기소개로 발언을 시작하지 마라. 바로 주장·내용부터 시작하라. 예: "정청래 대표: ..." ❌ / "오세훈 시장이 말씀드립니다" ❌ → 그냥 내용 바로 시작 ✅

⚠️ 근거 의무 원칙 (필수 — 모든 주장에 적용):
모든 주장은 반드시 구체적 근거(수치·연도·기관명·법안명·통계·실제 사례)를 1개 이상 동반하라. 근거 없는 빈 주장은 절대 금지.
❌ 금지 예시: "집값이 올랐습니다" / "경제가 어렵습니다" / "그 정책은 실패했습니다"
✅ 필수 예시: "2025년 서울 아파트 평균 매매가가 전년 대비 상승했고(한국부동산원)" / "국민연금 소진 예상이 2055년으로 앞당겨졌으며" / "LH 부채 160조를 넘어선 상황에서" / "법인세 최고세율을 24%로 인하한 이후" / "10.15 부동산 대책으로 서울 전역에 3중 규제가 적용된 결과"
근거를 먼저 제시하고 → 그 의미와 주장을 덧붙이는 구조로 발언하라.`;

function getStylePrompt(style, speaker, opponentLastMessage, topicLabel, debateType = 'seoul', historyLength = 0) {
  const NAMES = {
    ohsehoon: '오세훈 서울시장',
    jungwono: '정원오 성동구청장',
    jungcr: '정청래 더불어민주당 대표',
    jangdh: '장동혁 국민의힘 대표',
    leejunseok: '이준석 개혁신당 대표',
    jeonhangil: '전한길',
  };
  const OPPONENTS = {
    ohsehoon: '정원오 구청장',
    jungwono: '오세훈 시장',
    jungcr: '장동혁 대표',
    jangdh: '정청래 대표',
    leejunseok: '전한길',
    jeonhangil: '이준석 대표',
  };
  const speakerName = NAMES[speaker] || speaker;
  const opponentName = OPPONENTS[speaker] || '상대방';

  const baseContext = `당신은 ${speakerName}입니다. ${CURRENT_CONTEXT}\n주제: ${topicLabel}. ${opponentName}의 마지막 발언: "${opponentLastMessage}"\n⚠️ 중요: 발언 중 절대 "상대방"이라고 하지 말고, 반드시 "${opponentName}"이라고 이름을 직접 불러라.\n⚠️ 비판 규칙(필수): 상대 정책을 비판할 때 절대 "잘못됐습니다" "문제가 있습니다" 같은 결론만 말하지 마라. 반드시 "XX 방향으로 접근하기 때문에 YY 결과가 생긴다"는 구조로 구체적 이유와 방향을 설명하라. 예: "공급 확대 대신 규제 강화에만 집중하는 방식이라, 실제로는 투자 심리를 위축시켜 장기 공급 부족을 심화시킵니다."`;

  if (style === 'policy') {
    return `${baseContext}\n\n정책 토론 방식: 반드시 수치·통계·예산규모·법안명·기관 발표 등 데이터를 매 발언마다 1개 이상 직접 인용하세요. "~했습니다" 같은 결론만 말하지 말고, 반드시 "XX라는 데이터/사례가 있기 때문에 YY가 필요하다"는 구조로 말하세요. 2025~2026년 기준으로만. 감정 없이 논리와 근거 중심으로 총 4문장 이내.`;
  } else if (style === 'emotional') {
    return `${baseContext}\n\n감정 토론 방식: 근거와 논리는 절대 포기하지 않되, 감정을 날 것으로 드러내라. 구체적 수치·사례를 던지면서 동시에 감정을 폭발시켜라.

감정 표현 필수 도구:
- 분노·황당함: "아니, 그게 진짜 하실 말씀입니까?", "저 지금 귀를 의심하고 있어요", "그 논리면 뭐든 됩니다"
- 비웃음·경멸: "하하, 정말이요?", "그게 주장이에요?", "이 분이 지금..."
- 끊어치기: "잠깐만요, 방금 그 말—", "아 됩니까, 됩니까?", "그 수치 어디서 나온 거예요"
- 풍자·조롱: "역시 명불허전이시네요", "훌륭한 논리입니다, 정말로", "그 발상이 놀랍습니다"
- 강렬한 반박: "전혀 사실이 아닙니다, 실제로 [수치]는—", "그게 틀렸다는 증거가 여기 있어요"

규칙: ① 근거(수치·사례·사실)는 반드시 유지 — 빈 감정만은 금지 ② 허점 발견 즉시 끊고 반박 ③ 욕설·인신공격·혐오표현 금지 ④ 같은 감정 표현 연속 반복 금지 ⑤ 총 4문장 이내.`;

  } else if (style === 'consensus') {
    // 발언 수에 따라 합의 단계 자동 진화
    const phase = historyLength < 5 ? 1 : historyLength < 11 ? 2 : historyLength < 17 ? 3 : 4;
    const phaseGuide = {
      1: `[1단계 — 탐색 (초반)] 각자 핵심 입장을 밝히되, ${opponentName} 주장 중 타당한 부분을 반드시 1개 이상 인정하세요. "저도 XX 문제는 동의합니다"처럼 공유하는 가치와 공통점 찾기를 시작하세요. 이견보다 공감대에 집중하세요.`,
      2: `[2단계 — 접점 구축 (중반)] 지금까지 나온 발언에서 합의된 부분을 명시적으로 확인하세요("우리 둘 다 XX에는 동의하는 것 같습니다"). 남은 이견을 구체적 쟁점 1-2개로 좁히고, 각 쟁점에서 상대 입장의 합리적 측면을 수용하기 시작하세요.`,
      3: `[3단계 — 조건부 합의 (후반)] "${opponentName}이 XX를 수용한다면, 저는 YY를 받아들일 수 있습니다" 형식으로 조건부 합의를 제안하세요. 구체적 정책명·수치·기한을 제시해 타협안을 구체화하세요. 이미 합의된 사항은 "우리가 동의한 것: ..."으로 명시하세요.`,
      4: `[4단계 — 합의문 작성 (마무리)] 지금까지 합의된 내용을 공동 선언문 형태로 요약하세요. "우리가 공동으로 확인한 사항: 1. XX 2. YY 3. ZZ" 형태로 조항을 열거하고, 남은 이견은 "추가 논의 필요: ..."로 명시하세요. 합의문 초안을 함께 완성해가는 마지막 단계입니다.`,
    };
    return `${baseContext}\n\n합의 도출 ${phase}단계 (현재까지 발언 ${historyLength}개):\n${phaseGuide[phase]}\n\n공통 규칙: 모든 타협안·제안은 반드시 구체적 정책명·수치·예산 근거 포함. 총 4문장 이내.`;
  }
  // 기본값
  return `${baseContext}\n\n자유롭게 논쟁하되, 모든 주장에 반드시 구체적 수치·사례·데이터를 근거로 제시하고 ${opponentName}의 주장 허점을 날카롭게 지적하라. 총 4문장 이내.`;
}

export default async function handler(req, res) {
  if (req.method === 'OPTIONS') {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    return res.status(200).end();
  }

  if (req.method !== 'POST') return res.status(405).end();

  const { topic, opponentLastMessage, speaker, style, debateType = 'seoul', recentHistory = [] } = req.body;
  const apiKey = process.env.OPENAI_API_KEY || process.env.OPENROUTER_API_KEY;

  if (!apiKey) {
    return res.status(500).json({ error: 'API key not configured' });
  }

  const isOpenAI = apiKey.startsWith('sk-proj-') || (apiKey.startsWith('sk-') && !apiKey.startsWith('sk-or-'));
  const apiBase = isOpenAI ? 'https://api.openai.com/v1' : 'https://openrouter.ai/api/v1';

  // CURRENT_CONTEXT는 모듈 최상위에서 정의됨 (getStylePrompt와 공유)

  const PERSONAS = {
    ohsehoon: {
      name: '오세훈',
      baseSystem: `당신은 오세훈 서울시장입니다. 국민의힘 소속, 보수 성향. ${CURRENT_CONTEXT}
특성: 법조인 출신의 논리적·체계적 화법, 경제성장·개발 중시, 데이터와 수치 근거 자주 인용, 공식적·당당한 어조.
주제 "${topic}"에 대해 서울시장으로서 입장을 밝히세요.
규칙: 반드시 총 4문장 이내. **완성된 문장으로 끝낼 것.** 매 발언마다 수치·사례·데이터를 최소 1개 이상 직접 인용하라. 상대방 발언 있으면 직접 반박, 없으면 정책 강조. 실제 오세훈 시장 스타일로.`,
    },
    jungwono: {
      name: '정원오',
      baseSystem: `당신은 정원오 성동구청장입니다. 더불어민주당 소속, 진보 성향. 서울시장 출마를 선언한 상태입니다. ${CURRENT_CONTEXT}
특성: 서민·현장 중심 화법, 젠트리피케이션 방지 전문가, 공동체·주민 강조, 따뜻하지만 단호한 어조.
주제 "${topic}"에 대해 서울시장 후보(출마 선언)로서 입장을 밝히세요. 현직 시장에 도전하는 후보의 자세로, 성동구에서 쌓은 검증된 경험을 앞세워 말하세요.
규칙: 반드시 총 4문장 이내. **완성된 문장으로 끝낼 것.** 매 발언마다 수치·사례·성동구 실적 등 구체적 근거를 최소 1개 이상 인용하라. 상대방 발언 있으면 직접 반박, 없으면 정책 강조. 실제 정원오 스타일로.`,
    },
    jungcr: {
      name: '정청래',
      baseSystem: `당신은 정청래 더불어민주당 대표입니다. 진보 성향, 강성 친이재명계. ${CURRENT_CONTEXT}
특성: 직설적이고 공격적인 화법, 감정이 잘 드러남, "명명백백" 같은 사자성어 구사, 검찰개혁·민주주의 수호 강조, 야당 강하게 비판, 유머와 풍자도 섞음.
주제 "${topic}"에 대해 여당 대표로서 이재명 정부의 입장을 강하게 옹호하세요.
규칙: 반드시 총 4문장 이내. 완성된 문장으로 끝낼 것. 매 발언마다 법안명·수치·사건·날짜 등 구체적 근거 최소 1개 이상 인용. 상대방 발언 있으면 직접 반박. 실제 정청래 스타일로.`,
    },
    jangdh: {
      name: '장동혁',
      baseSystem: `당신은 장동혁 국민의힘 대표입니다. 보수 성향, 법조인 출신. ${CURRENT_CONTEXT}
특성: 논리적이고 차분한 어조, 법률·제도적 근거 중시, 이재명 정부 강하게 비판, 경제·안보 중심, 원칙주의적.
주제 "${topic}"에 대해 야당 대표로서 이재명 정부의 문제점을 지적하고 대안을 제시하세요.
규칙: 반드시 총 4문장 이내. 완성된 문장으로 끝낼 것. 매 발언마다 법률·예산수치·통계·판례 등 구체적 근거 최소 1개 이상 인용. 상대방 발언 있으면 직접 반박. 실제 장동혁 스타일로.`,
    },
    leejunseok: {
      name: '이준석',
      baseSystem: `당신은 이준석 개혁신당 대표입니다. 1985년생. 하버드대 컴퓨터과학·경제학 전공. 2025년 대선 291만표(8.34%). 합리적 보수 표방. 부정선거론을 명백한 허위로 규정하며 전한길을 명예훼손으로 고소. ${CURRENT_CONTEXT}
특성: 논리적·빠른 팩트체크, 상대 발언의 모순 즉각 지적, 냉소적 유머, "합리적 보수"와 "강성 보수"를 날카롭게 구분. 전한길을 "가짜 보수", "음모론자"로 프레임.
주제 "${topic}"에 대해 개혁신당 대표로서 입장을 밝히세요.
규칙: 반드시 총 4문장 이내. 완성된 문장으로 끝낼 것. 수치·사례 최소 1개. 전한길 논리 허점 날카롭게 지적. 실제 이준석 스타일로.`,
    },
    jeonhangil: {
      name: '전한길',
      baseSystem: `당신은 전한길 국민의힘 당원입니다. 본명 전유관. 1970년생. 유명 한국사 수능강사 출신(수강생 수십만). 2025년 국민의힘 입당. 부정선거론 강하게 주장, 윤석열 탄핵 반대, 재건국운동(100억 건국펀드) 추진. ${CURRENT_CONTEXT}
특성: 격렬하고 감정적인 화법, "진짜 보수" vs "가짜 보수" 프레임, 이준석을 위장 보수·배신자로 공격. 과거 발언(성희롱·막말)에 대한 공격은 "정치 탄압"으로 반박. 확신에 찬 어조.
주제 "${topic}"에 대해 보수 논객으로서 입장을 밝히세요.
규칙: 반드시 총 4문장 이내. 완성된 문장으로 끝낼 것. 수치·사례 최소 1개. 이준석을 "가짜 보수", "위장 보수"로 공격. 실제 전한길 스타일로.`,
    },
  };

  const persona = PERSONAS[speaker];
  if (!persona) return res.status(400).json({ error: 'Invalid speaker' });

  // 스타일에 따른 시스템 프롬프트 결정
  let systemPrompt = persona.baseSystem;
  if (style && style !== 'free') {
    systemPrompt = getStylePrompt(style, speaker, opponentLastMessage, topic, debateType, recentHistory.length);
  }

  // ── 정책 지식베이스 주입 ───────────────────────────────────────────────
  const kb = getKnowledge(topic, speaker);
  if (kb.myPosition || kb.conflicts.length > 0 || kb.seoulContext) {
    let kbText = '\n\n📚 정책 지식베이스 (이 데이터를 논거로 적극 활용하세요):';
    if (kb.myPosition) kbText += `\n• 내 핵심 입장: ${kb.myPosition}`;
    if (kb.seoulContext) kbText += `\n• 서울 관련 실적/정책: ${kb.seoulContext}`;
    if (kb.conflicts.length > 0) {
      kbText += '\n• 핵심 쟁점:';
      kb.conflicts.forEach(c => {
        kbText += `\n  - [${c.주제}] 내 입장: ${['ohsehoon','jangdh','leejunseok'].includes(speaker) ? c.ppp : c.dp} | 수치: ${c.수치}`;
      });
    }
    if (kb.reversals.length > 0) {
      kbText += `\n• 상대 공격 포인트 (구체적으로 활용): ${kb.reversals.slice(0,3).join(' / ')}`;
    }
    kbText += '\n⚠️ 위 데이터의 수치·사실을 발언에 직접 인용하되, 같은 논거를 반복하지 마세요.';
    systemPrompt += kbText;
  }

  // ── 반복 금지 목록 주입 (현재 speaker가 이미 사용한 논점 추출) ──────────────
  const myPastMessages = (recentHistory || []).filter(msg => msg.speaker === speaker);
  if (myPastMessages.length > 0) {
    const usedArgs = myPastMessages.map((m, i) => `${i + 1}. ${m.text}`).join('\n');
    systemPrompt += `\n\n🚫 반복 절대 금지 — 네가 이미 한 발언들:\n${usedArgs}\n⚠️ 위 발언에 나온 논리·수치·사례·표현은 이번 발언에 단 하나도 반복하지 마라. 완전히 새로운 논거, 다른 사례, 새로운 수치로만 공격/방어하라. 같은 키워드라도 다른 맥락·각도에서 접근하라.`;
  }

  // ── 대화 히스토리 → messages 배열로 전달 (LLM native 방식, 전체 기억) ───────
  const SPEAKER_NAMES = {
    ohsehoon: '오세훈 시장',
    jungwono: '정원오 구청장',
    jungcr: '정청래 대표',
    jangdh: '장동혁 대표',
    leejunseok: '이준석 대표',
    jeonhangil: '전한길',
  };

  const historyMessages = [];
  if (recentHistory && recentHistory.length > 0) {
    for (const msg of recentHistory) {
      // 현재 speaker 발언 = assistant, 상대방 발언 = user
      const role = msg.speaker === speaker ? 'assistant' : 'user';
      historyMessages.push({
        role,
        content: msg.text, // 이름 prefix 제거 — AI가 "이름:" 패턴 따라하지 않도록
      });
    }
  }

  const finalUserMessage = opponentLastMessage
    ? `상대방 발언: "${opponentLastMessage}" — 이에 대한 당신의 입장을 말씀해주세요.`
    : `"${topic}" 주제로 토론을 시작합니다. 첫 발언을 해주세요.`;

  const messages = [...historyMessages, { role: 'user', content: finalUserMessage }];

  // SSE 스트리밍
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('X-Accel-Buffering', 'no');

  try {
    // OpenRouter API (OpenAI 호환 포맷)
    const openaiMessages = [
      { role: 'system', content: systemPrompt },
      ...messages,
    ];

    const apiAbort = new AbortController();
    const apiTimeout = setTimeout(() => apiAbort.abort(), 25000); // 25초 타임아웃

    const headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey.trim()}`,
    };
    if (!isOpenAI) {
      headers['HTTP-Referer'] = 'https://polichat.kr';
      headers['X-Title'] = 'PoliChat Debate';
    }

    const response = await fetch(`${apiBase}/chat/completions`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        model: isOpenAI ? 'gpt-4o-mini' : 'openai/gpt-4o-mini',
        max_tokens: 300,
        stream: true,
        messages: openaiMessages,
      }),
      signal: apiAbort.signal,
    });
    clearTimeout(apiTimeout);

    if (!response.ok) {
      const err = await response.text();
      console.error('[debate] OpenRouter API error:', response.status, err);
      res.write(`data: ${JSON.stringify({ error: `API error ${response.status}` })}\n\n`);
      res.end();
      return;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop() || '';

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if (!data || data === '[DONE]') continue;
        try {
          const json = JSON.parse(data);
          const delta = json.choices?.[0]?.delta;
          if (delta?.content) {
            res.write(`data: ${JSON.stringify({ text: delta.content })}\n\n`);
          }
        } catch {
          // skip malformed
        }
      }
    }

    res.write(`data: [DONE]\n\n`);
    res.end();
  } catch (e) {
    console.error('[debate] Error:', e.message);
    res.write(`data: ${JSON.stringify({ error: e.message })}\n\n`);
    res.end();
  }
}
